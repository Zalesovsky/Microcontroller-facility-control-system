# Microcontroller-facility-control-system

## Описание проекта

Этот пет-проект, выпущенный 10.12.2020, представляет собой микроконтроллерную систему управления, которая принимает информацию от аналоговых и цифровых датчиков, обрабатывает эти данные в соответствии с законами управления и выдает управляющие воздействия на исполнительные механизмы. Система может управляться с помощью пульта управления и передавать обработанную информацию в систему более высокого уровня через последовательный канал связи.

## Компоненты системы

- **Микроконтроллер (МК)**
- **Пульт управления (ПУ)**
- **Последовательный канал связи (ПКС)**
- **Аналоговые и цифровые датчики (Д)**
- **Исполнительные механизмы (ИМ)**

## Функциональность

1. **Управление через пульт**: Пульт управления позволяет оператору запускать и останавливать микроконтроллер, а также считывать информацию о состоянии объекта.
2. **Последовательная связь**: Система может передавать обработанную информацию в систему более высокого уровня по запросу.
3. **Обработка данных датчиков**: Система считывает данные с аналоговых и цифровых датчиков и генерирует управляющие сигналы для исполнительных механизмов.
4. **Обработка аварийных ситуаций**: Система включает функциональность для обработки аварийных сигналов.

## Схемы

<details><summary>Структурная схема управления объектом</summary>

![image](https://github.com/Zalesovsky/Microcontroller-facility-control-system/assets/49143456/6087a8d5-8225-480b-9e2e-1a122f183283)

</details>

<details><summary>Структурная схема микропроцессорной системы управления</summary>

![image](https://github.com/Zalesovsky/Microcontroller-facility-control-system/assets/49143456/7571795d-99ff-447d-9451-c3f3c27629b0)

- AД - аналоговый датчик;
- ДЦ - цифровой датчик;
- БП - блок питания;
- ВК - выходной канал;
- МК – микроконтроллер;
- ИС - интерфейс связи;
- ПУ - пульт управления;
- К – кнопка;
- Т – тумблер;
- АС - аварийная сигнализация;
- СИ - семисегментная индикация

</details>

<details><summary>Электрическая схема</summary>

![10](https://github.com/Zalesovsky/Microcontroller-facility-control-system/assets/49143456/8c93c36f-2274-4fe7-8f57-cf2dfa9e11a8)

</details>

## Блок-схемы

<details><summary>Алгоритм системы</summary>

Алгоритм работы микроконтроллерной системы имеет следующий вид

![image](https://github.com/Zalesovsky/Microcontroller-facility-control-system/assets/49143456/daeebfc4-15c9-4407-9b3e-22aa2148961a)

Блок «Init» выполняет начальную установку системы: настройку периферийных модулей, посылку в выходные каналы начальных значений управляющих воздействий и т. д.

Блок «Digital» реализует задачу логического управления: принимает информацию от двоичных датчиков D1, ..., Dn, вычисляет значение булевой функции f(D1, ..., Dn) в соответствии с заданием и выдает это значение в качестве управляющего сигнала O1 по соответствующему выходному каналу на исполнительный механизм.

Блок «Analog» обеспечивает прием информации с аналогового датчика A, ее преобразование в цифровую форму, сравнение со значением Q и выдачу результата в качестве управляющего сигнала O2 по соответствующему выходному каналу на исполнительный механизм.

Блок «Loop» обеспечивает циклический режим управления или остановку системы в соответствии с командой, поступающей с пульта управления.
Микропроцессорная система опрашивает двоичные датчики D1, D2, D3 и по их значениям вычисляет булеву функцию «(!D1 && D2) || D3» согласно заданию на курсовую работу. При единичном значении функции система вырабатывает выходной сигнал O1 = 1 длительностью T1 = 55 мс, при нулевом значении выходной сигнал O1 = 0 без изменений. Согласно заданию, уровень логического нуля – «0В», уровень логической единицы – «23В»; выходное напряжение – 3,3В, максимальный ток коммутации канала – 300мА.

В системе имеется также двоичный датчик аварийной ситуации D0, единичный сигнал с которого должен вызвать аварийную остановку системы в любой момент выполнения рабочего цикла программы.
Сигнал с аналогового датчика A преобразовывается в цифровые сигналы при помощи внутреннего АЦП. С выхода АЦП сформированный 12 – разрядный код N, представляющий собой целое число без знака, поступает на обработку. Полученное значение N сравнивается с константой Q, которая хранится во внутренней памяти контроллера.
В зависимости от результатов сравнения система вырабатывает двоичные управляющие воздействия: O2 (если N < Q) длительностью T2 = 89мс или (если N > Q) длительностью T3 = 21 мс.

Система обрабатывает запросы на прерывание пяти уровней:
1) запрос на прерывание по сигналу аварийного датчика IRQ0;
2) запрос на прерывание от терминала внешней ЭВМ IRQ1;
3) запрос на прерывание от таймера IRQ2 (при необходимости).
Прерывание от сигнала аварийного датчика включает на пульте управления аварийную сигнализации - звуковую с частотой 250 Гц и обеспечивает выдачу на индикацию цифрового кода N, поступающего с АЦП. После этого отключаются выходные каналы O1 и O2.

Прерывания от терминала внешней ЭВМ осуществляются при приеме последовательным каналом связи символа управления обменом «?». Приемник последовательного адаптера выставляет при этом запрос на прерывание работы основной программы с целью передачи в последовательный канал связи запрашиваемой информации. Запрашиваемая информация формируется в зависимости от принятого из канала символа. При приеме символа «D» в канал передается значение O1, при приеме символа «А»– значение O2. После загрузки в буфер передатчика последовательного адаптера запрашиваемой информации управление передается в прерванную программу.

Пульт управления должен содержать следующие элементы:
1) семисегментный индикатор для индикации кода N;
2) зуммер, на который подаются импульсы с частотой f = 250 Гц;
3) кнопку «Сброс», при нажатии на которую осуществляется установка элементов системы в начальное состояние;
4) тумблер «Остановка», опрашиваемый в конце каждого цикла выполнения программы.

</details>

<details><summary>Алгоритм работы блока чтения информации с цифровых датчиков</summary>

![image](https://github.com/Zalesovsky/Microcontroller-facility-control-system/assets/49143456/8c455da2-6b8a-49c6-bc42-d553694433d7)

Работа блока чтения информации с цифровых датчиков начинается с установки времени таймера TIM6 для формирования выходного сигнала O1. Далее, после проверки выполнения булевой функции, формируется выходной сигнал O1 и запускается таймер TIM6. После отсчета времени T1 срабатывает обработчик прерывания таймера TIM6, который завершает формирование сигнала O1. Если булева функция не выполняется, то формирование сигнала не происходит.

</details>

<details><summary>Алгоритм работы блока чтения информации с аналогового датчика</summary>

![image](https://github.com/Zalesovsky/Microcontroller-facility-control-system/assets/49143456/2db50c4d-dc40-4093-baae-32b77e2bca3b)

Работа блока чтения информации с аналогового датчика начинается с запуска АЦП и ожидания окончания преобразования. После сброса флага окончания преобразования происходит расчет измеренного напряжения (U). Далее, результат расчета (U) сравнивается с константой (Q). Если Q > N, то таймер TIM6 настраивается на время T2, иначе T3. Затем, формируется сигнал O2 и запускается таймер TIM6. После отсчета времени T2 или T3 срабатывает обработчик прерывания таймера TIM6, который завершает формирование сигнала O2.

</details>

<details><summary>Алгоритм работы блока обмена данными по последовательному каналу связи</summary>

![image](https://github.com/Zalesovsky/Microcontroller-facility-control-system/assets/49143456/23a38417-012c-41df-bc09-a1b05ffbeb06)

Обработчик прерываний интерфейса UART, который проверяет прием символа управления обменом «?» и осуществляет прием следующего символа, вызывает блок обмена данными по последовательному каналу связи. Далее, блок обмена данными проверяет на соответствие принятый символ с символами «D» или «А» и выполняет отправку текущих данных соответственно О1 или О2.

</details>

<details><summary>Алгоритм работы блока взаимодействия с оператором</summary>

![image](https://github.com/Zalesovsky/Microcontroller-facility-control-system/assets/49143456/6ef758a6-8aa5-4635-a48d-ace9c05552a9)

Основной частью блока взаимодействия с оператором является проверка тумблера при выполнении основной части программы. За реагирование на нажатие кнопки «Сброс» и начальную установку элементов системы отвечает обработчик прерываний. Также в блок взаимодействия с оператором входит аварийная сигнализация и выдача на индикацию цифрового кода N, которые описаны блоке обработки аварийных ситуаций.

</details>

<details><summary>Алгоритм работы блока динамической индикации</summary>

![Алгоритм работы блока динамической индикации](https://github.com/Zalesovsky/Microcontroller-facility-control-system/assets/49143456/02a2c285-2b32-4534-b4c0-058bf873cec8)
![Алгоритм работы обработки аварийных ситуаций](https://github.com/Zalesovsky/Microcontroller-facility-control-system/assets/49143456/ba028eb7-a2a5-4676-987c-21809754265d)

Обработка аварийных ситуаций начинается с выполнения обработчика прерываний по поступлению сигнала на микроконтроллер от аварийного датчика D0.

Обработчик прерываний вызывает блок обработки аварийных ситуаций, который завершает формирование сигналов O1 и O2, а также блокирует пины PA7 и PA8. Затем, происходит установка времени таймера TIM6. Далее пин PA2(ES) устанавливается в «0» и запускается таймер TIM6 для формирования аварийного сигнала. Таймер TIM14 запускается для выдачи на индикацию цифрового кода N (динамическая индикация). После обработки аварийной ситуации микроконтроллер ожидает нажатия кнопки «Сброс».

Блок обработки динамической индикации определяет цифру текущего разряда, которую необходимо отобразить, включает необходимые пины для сегментов светодиодного индикатора и текущего разряда.

</details>

<details><summary>Алгоритмы работы обработчиков прерываний</summary>


В работе системы участвует 4 обработчика прерываний: обработчик прерываний поступления сигнала от аварийного датчика, обработчик прерываний поступления данных от ЭВМ, обработчики прерываний окончания счет таймеров TIM6 и TIM14.
Обработчик прерываний аварийного датчика устанавливает флаг принятия сигнала аварийной ситуации и вызывает блок обработки аварийных ситуаций.

<details><summary>Алгоритм работы обработчика прерываний аварийного датчика</summary>

![image](https://github.com/Zalesovsky/Microcontroller-facility-control-system/assets/49143456/a05169e1-2cad-4dcd-a0d9-cb6f85b192ea)

</details>

Обработчик прерываний поступления данных от ЭВМ проверяет, был ли принят символа управления обменом «?», вызывает блок обработки данных UART и сбрасывает символ управления обменом, иначе считывает принятый байт.

<details><summary>Алгоритм работы обработчика прерываний UART приемника</summary>

![image](https://github.com/Zalesovsky/Microcontroller-facility-control-system/assets/49143456/d4e8b62e-360c-4987-ab66-7215d1cb46bd)

</details>

Обработчик прерываний таймера TIM6 проверяет установлен ли пин PA7(O1) или PA8(O2) в «0», устанавливает соответственно PA7(O1) или PA8(O2) в «1» и включает таймер. Затем, проверяет установлен ли флаг аварийной ситуации и инвертирует состояние пина PA2(ES) – формирует сигналы аварийной ситуации.

<details><summary>Алгоритм работы обработчика прерываний таймера TIM6</summary>

![image](https://github.com/Zalesovsky/Microcontroller-facility-control-system/assets/49143456/8c3a4d53-5489-4524-bf26-e40d439a8d04)

</details>

Обработчик прерываний таймера TIM14 переключает разряд индикатора, который отображается в данный момент времени и вызывает блок динамической индикации.

<details><summary>Алгоритм работы обработчика прерываний таймера TIM14</summary>

![image](https://github.com/Zalesovsky/Microcontroller-facility-control-system/assets/49143456/d8511d9e-d70e-4908-bf23-e03f24b3bdfa)

</details>

</details>





